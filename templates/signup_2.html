<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedcode Registration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #f0f2f5;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        button {
            padding: 0.75rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        #scrapeBtn {
            background: #2196F3;
            color: white;
        }

        #scrapeBtn.success {
            background: #4CAF50;
        }

        #reasoningBtn {
            background: #2196F3;
            color: white;
        }

        #reasoningBtn.success {
            background: #4CAF50;
        }

        #registerBtn {
            background: #1e1e1e;
            color: white;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .error-message {
            color: #f44336;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" required>
            <div class="error-message" id="username-error"></div>
        </div>
        
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" required>
            <div class="error-message" id="password-error"></div>
        </div>

        <div class="form-group">
            <label for="cses_username">CSES Username</label>
            <input type="text" id="cses_username" required>
            <div class="error-message" id="cses-username-error"></div>
        </div>

        <div class="form-group">
            <label for="cses_password">CSES Password</label>
            <input type="password" id="cses_password" required>
            <div class="error-message" id="cses-password-error"></div>
        </div>

        <div class="button-group">
            <button id="scrapeBtn">Scrape</button>
            <button id="reasoningBtn" disabled>Generate Reasoning</button>
            <button id="registerBtn" disabled>Register</button>
        </form>
        <p class="account-exist">Account already exists? <a href="{{ url_for('login') }}">Login here</a></p>
    </div>
        </div>
        
    </div>

    <script>
        const scrapeBtn = document.getElementById('scrapeBtn');
        const reasoningBtn = document.getElementById('reasoningBtn');
        const registerBtn = document.getElementById('registerBtn');
        let scrapingComplete = true;
        let reasoningComplete = false;

        // Function to show error message
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // Function to clear error messages
        function clearErrors() {
            const errorElements = document.querySelectorAll('.error-message');
            errorElements.forEach(element => {
                element.style.display = 'none';
            });
        }

        // Function to validate inputs
        function validateInputs() {
            let username = document.getElementById('username').value;
            let password = document.getElementById('password').value;
            let csesUsername = document.getElementById('cses_username').value;
            let csesPassword = document.getElementById('cses_password').value;

            clearErrors();
            let isValid = true;

            if (!username) {
                showError('username-error', 'Username is required');
                isValid = false;
            }
            if (!password) {
                showError('password-error', 'Password is required');
                isValid = false;
            }
            if (!csesUsername) {
                showError('cses-username-error', 'CSES username is required');
                isValid = false;
            }
            if (!csesPassword) {
                showError('cses-password-error', 'CSES password is required');
                isValid = false;
            }

            return isValid;
        }

        // Scrape button click handler
        scrapeBtn.addEventListener('click', async () => {
            if (!validateInputs()) return;

            const csesUsername = document.getElementById('cses_username').value;
            const csesPassword = document.getElementById('cses_password').value;

            scrapeBtn.disabled = true;
            scrapeBtn.textContent = 'Scraping...';

            try {
                const response = await fetch('/scrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cses_username: csesUsername,
                        cses_password: csesPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    scrapeBtn.classList.add('success');
                    scrapeBtn.textContent = 'Scraping Complete';
                    reasoningBtn.disabled = false;
                    scrapingComplete = true;
                } else {
                    throw new Error(data.message || 'Scraping failed');
                }
            } catch (error) {
                showError('cses-username-error', error.message);
                scrapeBtn.textContent = 'Scrape';
                scrapeBtn.disabled = false;
            }
        });

        // Reasoning button click handler
        reasoningBtn.addEventListener('click', async () => {
            if (!validateInputs() || !scrapingComplete) return;

            reasoningBtn.disabled = true;
            reasoningBtn.textContent = 'Generating...';

            try {
                const response = await fetch('/generate-reasoning', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cses_username: document.getElementById('cses_username').value
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    reasoningBtn.classList.add('success');
                    reasoningBtn.textContent = 'Reasoning Generated';
                    registerBtn.disabled = false;
                    reasoningComplete = true;
                } else {
                    throw new Error(data.message || 'Reasoning generation failed');
                }
            } catch (error) {
                showError('cses-username-error', error.message);
                reasoningBtn.textContent = 'Generate Reasoning';
                reasoningBtn.disabled = false;
            }
        });

        // Register button click handler
        registerBtn.addEventListener('click', async () => {
            if (!validateInputs() || !scrapingComplete || !reasoningComplete) return;

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            registerBtn.disabled = true;
            registerBtn.textContent = 'Registering...';

            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        password
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Registration successful!');
                    window.location.href = data.redirect // Redirect to login page
                } else {
                    throw new Error(data.message || 'Registration failed');
                }
            } catch (error) {
                showError('username-error', error.message);
                registerBtn.disabled = false;
                registerBtn.textContent = 'Register';
            }
        });
    </script>
</body>
</html>